name: SaaS APK Generator

on:
  repository_dispatch:
    # PHP panelinden 'build_app' event'i geldiğinde çalışır
    types: [build_app]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Update App Identity (SaaS Logic)
        run: |
          # PHP'den gelen payload verilerini al
          APP_NAME="${{ github.event.client_payload.app_name }}"
          PACKAGE_NAME="${{ github.event.client_payload.package_name }}"
          ICON_URL="${{ github.event.client_payload.icon_url }}"
          
          echo "Building: $APP_NAME ($PACKAGE_NAME)"

          # 1. build.gradle içindeki applicationId'yi güncelle
          sed -i "s/applicationId \".*\"/applicationId \"$PACKAGE_NAME\"/" app/build.gradle
          
          # 2. strings.xml içindeki uygulama ismini güncelle
          # Not: Theme styles kullanmadığımız için sadece ismi değiştiriyoruz
          sed -i "s/<string name=\"app_name\">.*<\/string>/<string name=\"app_name\">$APP_NAME<\/string>/" app/src/main/res/values/strings.xml
          
          # 3. İkonu indir ve mevcut olanla değiştir (Eğer bir URL gönderildiyse)
          if [ "$ICON_URL" != "" ]; then
            curl -L "$ICON_URL" -o app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
            curl -L "$ICON_URL" -o app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
          fi

      - name: Grant Execute Permission
        run: chmod +x gradlew

      - name: Build Release APK
        # --no-daemon kullanarak belleği verimli kullanıyoruz
        run: ./gradlew assembleRelease --no-daemon

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.package_name }}-release
          path: app/build/outputs/apk/release/app-release.apk

      - name: Notify PHP Panel (Optional)
        # Build bittiğinde kendi sitene "Bitti" bilgisi gönderebilirsin
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"status": "completed", "package": "${{ github.event.client_payload.package_name }}"}' \
          https://imdatgel.site/git/api/build-status-update.php
