name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: 'WebView URL'
        required: true
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      version_code:
        description: 'Version Code'
        required: true
      version_name:
        description: 'Version Name'
        required: true
      user_id:
        description: 'User ID / Token'
        required: true
      icon_url:
        description: 'Icon Download URL'
        required: true
      change_icon:
        description: 'Change Icon? (true/false)'
        required: true
        default: 'true'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # --- İSİM, PAKET ADI VE SÜRÜM GÜNCELLEME ---
      - name: Update App Name and Config
        run: |
          # Strings.xml içindeki app_name'i değiştir
          sed -i 's/My Application/${{ github.event.inputs.app_name }}/g' app/src/main/res/values/strings.xml
          
          # Gradle dosyasındaki sürüm ve paket adını değiştir
          sed -i 's/applicationId "com.example.myapp"/applicationId "${{ github.event.inputs.package_name }}"/g' app/build.gradle
          sed -i 's/versionCode 1/versionCode ${{ github.event.inputs.version_code }}/g' app/build.gradle
          sed -i 's/versionName "1.0"/versionName "${{ github.event.inputs.version_name }}"/g' app/build.gradle
          
          # MainActivity içindeki URL'yi değiştir (Eğer kodunda varsa)
          # sed -i 's|https://google.com|${{ github.event.inputs.site_url }}|g' app/src/main/java/com/example/myapp/MainActivity.java

      # --- İKON GÜNCELLEME (KOŞULLU) ---
      # Sadece change_icon 'true' ise çalışır
      - name: Update App Icon
        if: ${{ github.event.inputs.change_icon == 'true' }}
        run: |
          echo "İkon değişikliği talep edildi. İndiriliyor..."
          
          # İkonu indir
          wget -O temp_icon.png "${{ github.event.inputs.icon_url }}"
          
          # Mipmap klasörlerine kopyala (Tüm boyutlar için aynı görseli kullanıyoruz)
          cp temp_icon.png app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp temp_icon.png app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp temp_icon.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp temp_icon.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          cp temp_icon.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          
          # Yuvarlak ikon varsa onu da güncelle
          cp temp_icon.png app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png || true
          
          echo "İkonlar güncellendi!"

      # --- BUILD ---
      - name: Build APK
        run: ./gradlew assembleRelease

      # --- UPLOAD ---
      - name: Upload APK to Server
        run: |
          APK_PATH=app/build/outputs/apk/release/app-release-unsigned.apk
          if [ ! -f "$APK_PATH" ]; then
            APK_PATH=app/build/outputs/apk/release/app-release.apk
          fi
          
          curl -F "file=@$APK_PATH" -F "user_id=${{ github.event.inputs.user_id }}"   https://imdatgel.site/git/upload.php/git/webhook.php

      - name: Upload Artifact (Backup)
        uses: actions/upload-artifact@v3
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
