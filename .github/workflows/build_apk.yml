name: Build Signed AAB and APK

on:
  workflow_dispatch:
    inputs:
      site_url:
        required: true
      app_name:
        required: true
      package_name:
        required: true
      version_code:
        required: true
        default: '1'
      version_name:
        required: true
        default: '1.0'
      user_id: 
        required: true
      icon_url:
        required: false
        default: 'default'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    # 1. KEYSTORE'U OLUŞTUR (Base64'ten Dosyaya)
    - name: Decode Keystore
      run: |
        echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 --decode > app/upload-keystore.jks

    # 2. build.gradle'ı İMZALI OLARAK YENİDEN YAZ
    # Bu yöntem 'sed' ile uğraşmaktan çok daha güvenlidir.
    - name: Rewrite build.gradle with Signing Config
      run: |
        cat <<EOF > app/build.gradle
        plugins {
            id 'com.android.application'
        }
        android {
            namespace 'com.kodhocasi.template'
            compileSdk 33
            defaultConfig {
                applicationId "${{ github.event.inputs.package_name }}"
                minSdk 24
                targetSdk 33
                versionCode ${{ github.event.inputs.version_code }}
                versionName "${{ github.event.inputs.version_name }}"
                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }
            signingConfigs {
                release {
                    storeFile file("upload-keystore.jks")
                    storePassword "${{ secrets.SIGNING_STORE_PASSWORD }}"
                    keyAlias "${{ secrets.SIGNING_KEY_ALIAS }}"
                    keyPassword "${{ secrets.SIGNING_KEY_PASSWORD }}"
                }
            }
            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                    signingConfig signingConfigs.release
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
        }
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.9.0'
            implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
        }
        EOF

    # 3. Ayarları ve İkonu İşle
    - name: Configure App Details
      run: |
        # URL
        sed -i 's|REPLACE_THIS_URL|${{ github.event.inputs.site_url }}|g' app/src/main/java/com/kodhocasi/template/MainActivity.java
        # İSİM
        sed -i 's|<string name="app_name">.*</string>|<string name="app_name">${{ github.event.inputs.app_name }}</string>|g' app/src/main/res/values/strings.xml
        
        # İKON İNDİRME
        ICON_URL="${{ github.event.inputs.icon_url }}"
        if [ "$ICON_URL" != "default" ]; then
          curl -L "$ICON_URL" -o new_icon.png
          # Tüm boyutlara kopyala
          for folder in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            cp new_icon.png app/src/main/res/$folder/ic_launcher.png
            cp new_icon.png app/src/main/res/$folder/ic_launcher_round.png
          done
        fi

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 4. HEM AAB HEM APK OLUŞTUR (İmzalı)
    - name: Build Release AAB and APK
      run: |
        ./gradlew bundleRelease assembleRelease --no-daemon

    # 5. İKİSİNİ DE SUNUCUYA GÖNDER
    - name: Upload to Server
      run: |
        curl -X POST \
             -F "apk_file=@app/build/outputs/apk/release/app-release.apk" \
             -F "aab_file=@app/build/outputs/bundle/release/app-release.aab" \
             -F "secret=GIZLI_SIFRE_123" \
             -F "app_token=${{ github.event.inputs.user_id }}" \
            https://imdatgel.site/git/upload.php
