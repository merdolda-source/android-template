name: Build Pro Android APK

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: 'Router URL'
        required: true
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.pro.webapp'
      user_id:
        description: 'User ID'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    # ==================================================================
    # 1. ADIM: REPO SORUNLARINI VE build.gradle HATALARINI DUZELT
    # ==================================================================
    - name: Fix Project Files
      run: |
        echo "Dosyalar onariliyor..."

        # 1. KOK BUILD.GRADLE (Temiz ve Guncel Depolar)
        # 403 hatasini cozmek icin burayi temizliyoruz.
        cat <<EOF > build.gradle
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.1'
            }
        }
        allprojects {
            repositories {
                google()
                mavenCentral()
                maven { url "https://jitpack.io" }
            }
        }
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF

        # 2. APP BUILD.GRADLE (Standart Ayarlar)
        # Senin hatani (default:) cozmek icin burayi standart hale getiriyoruz.
        cat <<EOF > app/build.gradle
        plugins {
            id 'com.android.application'
        }
        android {
            namespace 'com.kodhocasi.template'
            compileSdk 33
            defaultConfig {
                applicationId "REPLACE_THIS_ID"
                minSdk 24
                targetSdk 33
                versionCode 1
                versionName "1.0"
                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }
            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
        }
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.9.0'
            implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
        }
        EOF

    # ==================================================================
    # 2. ADIM: PROFESYONEL JAVA KODUNU GÖM (Gezinme & Geri Tuşu)
    # ==================================================================
    - name: Inject Professional Code
      run: |
        # MainActivity.java - Gelismis WebView Ayarlari
        cat <<EOF > app/src/main/java/com/kodhocasi/template/MainActivity.java
        package com.kodhocasi.template;

        import android.os.Bundle;
        import android.view.KeyEvent;
        import android.webkit.WebSettings;
        import android.webkit.WebView;
        import android.webkit.WebViewClient;
        import androidx.appcompat.app.AppCompatActivity;

        public class MainActivity extends AppCompatActivity {

            private WebView myWebView;
            // Bu URL asagida sed komutuyla degistirilecek
            private String targetUrl = "REPLACE_THIS_URL";

            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                setContentView(R.layout.activity_main);

                myWebView = findViewById(R.id.webview);
                WebSettings webSettings = myWebView.getSettings();
                
                // TUM OZELLIKLERI AC
                webSettings.setJavaScriptEnabled(true);
                webSettings.setDomStorageEnabled(true);
                webSettings.setLoadWithOverviewMode(true);
                webSettings.setUseWideViewPort(true);
                webSettings.setBuiltInZoomControls(true);
                webSettings.setDisplayZoomControls(false);
                webSettings.setAllowFileAccess(true);
                webSettings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);
                
                // Linklerin uygulama icinde acilmasini sagla
                myWebView.setWebViewClient(new WebViewClient() {
                    @Override
                    public boolean shouldOverrideUrlLoading(WebView view, String url) {
                        view.loadUrl(url);
                        return true;
                    }
                });

                myWebView.loadUrl(targetUrl);
            }

            // Geri tusuna basinca uygulamadan cikmak yerine onceki sayfaya git
            @Override
            public boolean onKeyDown(int keyCode, KeyEvent event) {
                if (event.getAction() == KeyEvent.ACTION_DOWN) {
                    switch (keyCode) {
                        case KeyEvent.KEYCODE_BACK:
                            if (myWebView.canGoBack()) {
                                myWebView.goBack();
                            } else {
                                finish();
                            }
                            return true;
                    }
                }
                return super.onKeyDown(keyCode, event);
            }
        }
        EOF

        # MANIFEST DUZENLEME (HTTP Izni)
        cat <<EOF > app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            xmlns:tools="http://schemas.android.com/tools">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="@string/app_name"
                android:supportsRtl="true"
                android:usesCleartextTraffic="true"
                android:theme="@style/Theme.AppCompat.Light.NoActionBar"
                tools:targetApi="31">
                <activity
                    android:name=".MainActivity"
                    android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

        # 3. KULLANICI AYARLARINI GOMME
        echo "Kullanici bilgileri isleniyor..."
        
        # URL
        sed -i 's|REPLACE_THIS_URL|${{ github.event.inputs.site_url }}|g' app/src/main/java/com/kodhocasi/template/MainActivity.java

        # Uygulama Adi
        sed -i 's|<string name="app_name">.*</string>|<string name="app_name">${{ github.event.inputs.app_name }}</string>|g' app/src/main/res/values/strings.xml

        # Paket Adi (ID)
        sed -i 's|REPLACE_THIS_ID|${{ github.event.inputs.package_name }}|g' app/build.gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build APK
      run: ./gradlew assembleDebug --parallel --build-cache --no-daemon
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
