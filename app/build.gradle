name: Build Pro Android APK

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: 'Router URL'
        required: true
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
        default: 'com.pro.webapp'
      user_id:
        description: 'User ID'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Inject Professional Code
      run: |
        echo "Profesyonel Java kodu enjekte ediliyor..."
        
        # 1. MainActivity.java'yı TAMAMEN YENİDEN YAZIYORUZ
        # Bu kod sayesinde geri tuşu çalışır, linkler uygulama içinde açılır.
        
        cat <<EOF > app/src/main/java/com/kodhocasi/template/MainActivity.java
        package com.kodhocasi.template;

        import android.os.Bundle;
        import android.view.KeyEvent;
        import android.webkit.WebSettings;
        import android.webkit.WebView;
        import android.webkit.WebViewClient;
        import androidx.appcompat.app.AppCompatActivity;

        public class MainActivity extends AppCompatActivity {

            private WebView myWebView;
            // Burasi dinamik degisecek
            private String targetUrl = "REPLACE_THIS_URL";

            @Override
            protected void onCreate(Bundle savedInstanceState) {
                super.onCreate(savedInstanceState);
                setContentView(R.layout.activity_main);

                myWebView = findViewById(R.id.webview);
                WebSettings webSettings = myWebView.getSettings();
                
                // TUM OZELLIKLERI AC (Full Access)
                webSettings.setJavaScriptEnabled(true);
                webSettings.setDomStorageEnabled(true);
                webSettings.setLoadWithOverviewMode(true);
                webSettings.setUseWideViewPort(true);
                webSettings.setBuiltInZoomControls(true);
                webSettings.setDisplayZoomControls(false);
                webSettings.setAllowFileAccess(true);
                
                // Linklerin uygulama icinde acilmasini saglayan kod
                myWebView.setWebViewClient(new WebViewClient() {
                    @Override
                    public boolean shouldOverrideUrlLoading(WebView view, String url) {
                        view.loadUrl(url);
                        return true;
                    }
                });

                myWebView.loadUrl(targetUrl);
            }

            // Geri tusuna basinca uygulamadan cikmak yerine onceki sayfaya git
            @Override
            public boolean onKeyDown(int keyCode, KeyEvent event) {
                if (event.getAction() == KeyEvent.ACTION_DOWN) {
                    switch (keyCode) {
                        case KeyEvent.KEYCODE_BACK:
                            if (myWebView.canGoBack()) {
                                myWebView.goBack();
                            } else {
                                finish();
                            }
                            return true;
                    }
                }
                return super.onKeyDown(keyCode, event);
            }
        }
        EOF

        # 2. MANIFEST DUZENLEME (HTTP Izni ve Tema)
        # Mevcut manifesti silip temiz bir tane yaziyoruz.
        cat <<EOF > app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            xmlns:tools="http://schemas.android.com/tools">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="@string/app_name"
                android:supportsRtl="true"
                android:usesCleartextTraffic="true"
                android:theme="@style/Theme.AppCompat.Light.NoActionBar"
                tools:targetApi="31">
                <activity
                    android:name=".MainActivity"
                    android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

        # 3. KULLANICI AYARLARINI GOMME (sed komutlari)
        # URL'yi yerlestir
        sed -i 's|REPLACE_THIS_URL|${{ github.event.inputs.site_url }}|g' app/src/main/java/com/kodhocasi/template/MainActivity.java

        # Uygulama Adini yerlestir
        sed -i 's|<string name="app_name">.*</string>|<string name="app_name">${{ github.event.inputs.app_name }}</string>|g' app/src/main/res/values/strings.xml

        # Paket Adini yerlestir
        sed -i 's|applicationId ".*"|applicationId "${{ github.event.inputs.package_name }}"|g' app/build.gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build APK
      run: ./gradlew assembleDebug --parallel --build-cache --no-daemon
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
