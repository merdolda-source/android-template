name: Build Signed Release APK (Final Fix)

on:
  workflow_dispatch:
    inputs:
      site_url:
        description: 'Web Site URL'
        required: true
      app_name:
        description: 'App Name'
        required: true
      package_name:
        description: 'Package Name'
        required: true
      version_code:
        description: 'Version Code'
        required: true
        default: '1'
      version_name:
        description: 'Version Name'
        required: true
        default: '1.0'
      user_id: 
        description: 'App Token'
        required: true
      icon_url:
        description: 'Icon URL'
        required: false
        default: 'default'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    # 1. KEYSTORE OLUŞTUR
    - name: Decode Keystore
      run: |
        echo "${{ secrets.SIGNING_KEY_STORE_BASE64 }}" | base64 --decode > app/upload-keystore.jks

    # 2. GRADLE AYARLARINI YENİDEN YAZ (İMZALI)
    - name: Rewrite build.gradle
      run: |
        cat <<EOF > app/build.gradle
        plugins {
            id 'com.android.application'
        }
        android {
            namespace 'com.kodhocasi.template'
            compileSdk 33
            defaultConfig {
                applicationId "${{ github.event.inputs.package_name }}"
                minSdk 24
                targetSdk 33
                versionCode ${{ github.event.inputs.version_code }}
                versionName "${{ github.event.inputs.version_name }}"
                testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
            }
            signingConfigs {
                release {
                    storeFile file("upload-keystore.jks")
                    storePassword "${{ secrets.SIGNING_STORE_PASSWORD }}"
                    keyAlias "${{ secrets.SIGNING_KEY_ALIAS }}"
                    keyPassword "${{ secrets.SIGNING_KEY_PASSWORD }}"
                }
            }
            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                    signingConfig signingConfigs.release
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
        }
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.9.0'
            implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
        }
        EOF

    # 3. İSİM VE URL AYARLA
    - name: Configure App Details
      run: |
        sed -i 's|REPLACE_THIS_URL|${{ github.event.inputs.site_url }}|g' app/src/main/java/com/kodhocasi/template/MainActivity.java
        sed -i 's|<string name="app_name">.*</string>|<string name="app_name">${{ github.event.inputs.app_name }}</string>|g' app/src/main/res/values/strings.xml

    # 4. İKON GÜNCELLEME (PATLAMAYAN MOD)
    # Bu adım başarısız olsa bile build devam eder.
    - name: Update App Icon (Bulletproof)
      continue-on-error: true 
      run: |
        ICON_URL="${{ github.event.inputs.icon_url }}"
        echo "Gelen URL: $ICON_URL"
        
        # Link 'default' değilse ve 'http' içeriyorsa dene
        if [[ "$ICON_URL" != "default" && "$ICON_URL" == http* ]]; then
          
          echo "Dosya indiriliyor..."
          # -f: Hata varsa indirme (404 indirme)
          # -L: Yönlendirmeleri takip et
          curl -f -L "$ICON_URL" -o temp_icon_check.png || echo "İndirme başarısız."

          # İndirme başarılıysa kontrol et
          if [ -f temp_icon_check.png ]; then
             FILE_TYPE=$(file --mime-type -b temp_icon_check.png)
             echo "Dosya Tipi: $FILE_TYPE"

             # Eğer GERÇEKTEN resimse kopyala
             if [[ "$FILE_TYPE" == "image/png" || "$FILE_TYPE" == "image/jpeg" ]]; then
                echo "✅ Resim doğrulandı. İkonlar değiştiriliyor..."
                for folder in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
                  cp temp_icon_check.png app/src/main/res/$folder/ic_launcher.png
                  cp temp_icon_check.png app/src/main/res/$folder/ic_launcher_round.png
                done
             else
                echo "⛔ İndirilen dosya RESİM DEĞİL (HTML olabilir). İkon değiştirilmedi."
                # Dosyayı silmiyoruz, orijinal ikonlar kalıyor. Hata vermiyoruz.
             fi
          else
             echo "Dosya indirilemediği için atlanıyor."
          fi
        else
          echo "Varsayılan ikon kullanılacak."
        fi

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 5. BUILD AL (APK + AAB)
    - name: Build Release
      run: ./gradlew bundleRelease assembleRelease --no-daemon

    # 6. SUNUCUYA YÜKLE (Hata Olsa da Devam Et)
    - name: Upload to Server
      continue-on-error: true
      run: |
        echo "Sunucuya yükleniyor..."
        # ADRESİ DEĞİŞTİR
        curl -X POST \
             -F "apk_file=@app/build/outputs/apk/release/app-release.apk" \
             -F "aab_file=@app/build/outputs/bundle/release/app-release.aab" \
             -F "secret=GIZLI_SIFRE_123" \
             -F "app_token=${{ github.event.inputs.user_id }}" \
             https://imdatgel.site/git/upload.php
